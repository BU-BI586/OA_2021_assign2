---
title: "Untitled"
author: "Olivia Nieves, Maria Ingersoll, Alexia Kotorov"
date: "3/23/2021"
output: html_document
---
Set your working directory.
```{r}
setwd("C:/Users/Olivia Nieves/Documents/BU undergrad/BI586/OA_assign2") 
```

Library the necessary packages.
```{r}
library(DESeq2) 
library(affycoretools)
library(arrayQualityMetrics)
library(genefilter)
library(Biobase)
library(ggplot2)
library(dplyr)
library(pheatmap)
library(vegan)
library(ggrepel)
library(tidyverse)
library(RColorBrewer)
library(gplots)
library(VennDiagram)
```

Look for outliers. First, read in counts then create arrayQualityMetrics report and check HTML export file for outliers. NOTE: no outliers found in our data set.
```{r}
countData <- read.table("1.Assign2_GE_Sym_OA.csv", sep=",", header=T)
head(countData)
row.names(countData)=countData$X
countData$X=NULL
length(countData[,1])
#41850
treat=c( "Control", "P2553", "P2553", "Control")
g=data.frame(treat)
g
colData<- g

dds<-DESeqDataSetFromMatrix(countData=countData, colData=g, design=~treat)

vsd.ge=assay(vst(dds))
rl=vst(dds)
e=ExpressionSet(assay(rl), AnnotatedDataFrame(as.data.frame(colData(rl))))
arrayQualityMetrics(e,intgroup=c("treat"),force=T)
```

Re-read in counts and Plot counts.
```{r}
countData <- read.table("1.Assign2_GE_Sym_OA.csv", sep=",", header=T)
head(countData)
row.names(countData)=countData$X
countData$X=NULL
length(countData[,1])

totalCounts=colSums(countData)
totalCounts
barplot(totalCounts, col=c("coral", "blue", "blue", "coral"), ylab="raw counts")
```

DESeq analysis to see how our data varies by treatment. Re-read in counts then perform DESeq function.
```{r}
countData <- read.table("1.Assign2_GE_Sym_OA.csv", sep=",", header=T)
head(countData)
row.names(countData)=countData$X
countData$X=NULL
length(countData[,1])
treat=c( "Control", "P2553", "P2553", "Control")
g=data.frame(treat)
g
colData<- g


dds<-DESeqDataSetFromMatrix(countData=countData, colData=colData, design=~treat) 

dds<-DESeq(dds)
head(dds)
res<- results(dds)
```

Look at dispersion plot.
```{r}
plotDispEsts(dds, main="Dispersion plot")
```

P2553 vs. Control pairwise comparison (we're looking at gene expression RELATIVE to the control). MA plot to look at the depth of convergance.
```{r}
resP2553 <- results(dds, contrast=c("treat","P2553","Control"))
table(resP2553$padj<0.01)
summary(resP2553)

nrow(resP2553[resP2553$padj<0.05 & !is.na(resP2553$padj),])

plotMA(resP2553, main="Control vs P2553")
plotMA(resP2553, main="Control vs P2553", ylim=c(-2,2))
```

Use pairwise comparison to determaine the amount of up and downregulated genes in the P2553 treatment.
```{r}
results <- as.data.frame(resP2553)
head(results)

nrow(resP2553[resP2553$padj<0.1 & resP2553$log2FoldChange > 0 & !is.na(resP2553$padj),])
nrow(resP2553[resP2553$padj<0.1 & resP2553$log2FoldChange < 0 & !is.na(resP2553$padj),])

write.table(resP2553, file="P2553.txt", quote=F, sep="\t")

cd <- read.table("P2553.txt")
head(cd)
```

Make the GO table.
```{r}
go_input_P2553 = cd %>%
  tibble::rownames_to_column(var = "iso") %>%
  mutate(mutated_p = -log(pvalue)) %>%
  mutate(mutated_p_updown = ifelse(log2FoldChange < 0, mutated_p*-1, mutated_p*1)) %>%
  na.omit() %>%
  select(iso, mutated_p_updown)
head(go_input_P2553)
colnames(go_input_P2553) <- c("gene", "pval")
head(go_input_P2553)
write.csv(go_input_P2553, file="P2553_GO.csv", quote=F, row.names=FALSE)
```

Get p values.
```{r}
val2553=cbind(resP2553$pvalue, resP2553$padj)
head(val2553)
colnames(val2553)=c("pval.2553", "padj.2553")
length(val2553[,1])
table(complete.cases(val2553))
```

Make rlogdata and pvals table.
```{r}
rlog=rlogTransformation(dds, blind=TRUE) 
rld=assay(rlog)
head(rld)
colnames(rld)=paste(colData$treat)
head(rld)
length(rld[,1])

rldpvals=cbind(rld,val2553)
head(rldpvals)
dim(rldpvals)
table(complete.cases(rldpvals))

write.csv(rldpvals, "OA_assign2_RLDandPVALS.csv", quote=F)

colnames(rld)=paste(colData$treat)
head(rld)
```

Create a sample distance heat map.
```{r}
sampleDists <- as.matrix(dist(t(rld)))
heatmap.2(as.matrix(sampleDists), key=F, trace="none",
          col=colorpanel(100, "black", "white"),
          margin=c(10, 10), main="Sample Distance Matrix")
```

Make venn diagrams.
```{r}
P2553_up=row.names(resP2553[resP2553$padj<0.1 & !is.na(resP2553$padj) & resP2553$log2FoldChange>0,])
length(P2553_up)
P2553_down=row.names(resP2553[resP2553$padj<0.1 & !is.na(resP2553$padj) & resP2553$log2FoldChange<0,])
length(P2553_down)

P2553=row.names(resP2553[resP2553$padj<0.1 & !is.na(resP2553$padj),])

candidates=list("P2553"=P2553)
prettyvenn=venn.diagram(
  x = candidates,
  filename=NULL,
  col = "transparent",
  fill = c("coral2"),
  alpha = 0.5,
  cex = 2.5,
  fontfamily = "sans",
  fontface = "bold",
  cat.default.pos = "text",
  cat.col = c("darkred"),
  cat.cex = 2.5,
  cat.fontfamily = "sans",
  cat.dist = c(0.08),
  cat.pos = 1)

grid.draw(prettyvenn)
```

